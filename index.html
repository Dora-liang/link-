<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç¾è‚¡ Â· å…¨å¸‚åœºTop10 + å•ç¥¨ All-in-Oneï¼ˆMA5/10/20/60ï¼‰Â· é›†æˆç‰ˆ</title>
<style>
  :root{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif}
  body{margin:20px;background:#0b1220;color:#e9eef7}
  h1{margin:0 0 8px;font-size:22px}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #284071;cursor:pointer;background:#0e1730;color:#bcd0ff}
  .tab.active{background:#2c4b86;color:#fff}
  .pane{display:none}.pane.active{display:block}
  .card{background:#11192e;border:1px solid #1d2a4a;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#1c2b4e;display:inline-block;font-size:12px;color:#b9c8ea}
  input,select,textarea{padding:8px 10px;border-radius:10px;border:1px solid #26365e;background:#0d1528;color:#e9eef7}
  .muted{color:#9fb2d7;font-size:12px}
  .good{color:#36d399}.bad{color:#f87171}.warn{color:#fbbf24}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;border-bottom:1px solid #203058;font-size:12px;text-align:right;white-space:nowrap}
  th:first-child,td:first-child{text-align:left}
  progress{width:260px;height:10px}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .btn{background:#375dfb;border:none;color:#fff;padding:9px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.secondary{background:#1f2b4b}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  #logbox{max-height:160px;overflow:auto;background:#0d1528;border:1px solid #27355e;border-radius:8px;padding:8px;font-family:ui-monospace,Consolas,monospace;color:#cfe1ff}
  textarea{min-height:120px;font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .kpi{display:flex;gap:12px;flex-wrap:wrap}
  .kpi>div{background:#0e1730;border:1px solid #22345f;border-radius:14px;padding:10px 12px}
  .kpi .label{font-size:12px;color:#93a8d7}
  .kpi .val{font-size:18px;font-weight:700;color:#fff}
  .bar{height:10px;background:#1a2543;border-radius:6px;overflow:hidden}
  .bar>span{display:block;height:100%;background:#3baefb;width:0%;transition:width .2s ease}
  th.sortable{cursor:pointer}
</style>
</head>
<body>
<h1>ğŸ“Š ç¾è‚¡ Â· å…¨å¸‚åœºTop10 + å•ç¥¨ All-in-Oneï¼ˆMA5/10/20/60ï¼‰Â· é›†æˆç‰ˆ</h1>
<div class="muted">æ•°æ®æºå¯é€‰ï¼šYahooï¼ˆä»£ç†ï¼Œå…æ¢¯å­ï¼‰ã€Stooqï¼ˆCSVï¼Œå…Keyï¼‰ã€TwelveDataï¼ˆéœ€å…è´¹Keyï¼‰ã€‚æ‰«æåªç”¨<b>æœ€æ–°æ”¶ç›˜æ—¥</b>æ‰“åˆ†ï¼›å•ç¥¨æ”¯æŒåœ¨çº¿å–æ•°/ç¦»çº¿ç²˜è´´/æ‰‹åŠ¨è¾“å…¥ã€‚</div>

<div class="tabs">
  <div class="tab active" data-pane="scanner">å…¨å¸‚åœº Top10 + å•ç¥¨åˆ†æ</div>
</div>

<!-- ============ Pane: Scanner ============ -->
<div id="scanner" class="pane active">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="pill">è‚¡ç¥¨æ± ï¼ˆNASDAQ / NYSE / AMEXï¼‰</div>
      <div class="row">
        <button class="btn secondary" id="reload">é‡æ–°æ‹‰å–ç›®å½•</button>
        <button class="btn" id="scan">å¼€å§‹æ‰«æ</button>
        <button class="btn" id="stop" disabled>åœæ­¢</button>
      </div>
    </div>

    <div class="row" style="margin-top:6px;gap:14px">
      <div class="pill">ç­›é€‰</div>
      <label class="muted"><input type="checkbox" id="exNAS" checked> çº³æ–¯è¾¾å…‹</label>
      <label class="muted"><input type="checkbox" id="exNYS" checked> çº½äº¤æ‰€</label>
      <label class="muted"><input type="checkbox" id="exASE" checked> ç¾äº¤æ‰€ï¼ˆAMEXï¼‰</label>
      <label class="muted"><input type="checkbox" id="noETF" checked> æ’é™¤ETF</label>
      <label class="muted"><input type="checkbox" id="noWUR" checked> æ’é™¤Warrant/Unit/Right</label>
      <label class="muted"><input type="checkbox" id="onlyCommon" checked> ä»…æ™®é€šè‚¡</label>
    </div>

    <div class="row" style="margin-top:6px;gap:14px">
      <div class="pill">å–æ•°æº</div>
      <label class="muted">ä»·æ ¼/é‡ï¼š
        <select id="priceSource">
          <option value="yahoo" selected>Yahooï¼ˆä»£ç†ï¼Œå…Keyï¼‰</option>
          <option value="stooq">Stooqï¼ˆCSVï¼Œå…Keyï¼‰</option>
          <option value="twelve">TwelveDataï¼ˆéœ€Keyï¼‰</option>
        </select>
      </label>
      <label class="muted" id="twKeyWrap" style="display:none">TwelveData Key <input id="twKey" placeholder="twelvedata.com å…è´¹è·å–"></label>
      <label class="muted">å¸‚å€¼ï¼š
        <select id="mcapSource">
          <option value="yahoo" selected>Yahoo Quoteï¼ˆå…Keyï¼‰</option>
          <option value="none">ä¸å–ï¼ˆæŒ‰æŠ€æœ¯åˆ†æ’åºï¼‰</option>
        </select>
      </label>
    </div>

    <div class="row" style="margin-top:6px;gap:14px">
      <div class="pill">æ€§èƒ½</div>
      <label class="muted">æœ€å¤šæ‰«æ <input id="limit" type="number" step="1" value="80" style="width:90px"></label>
      <label class="muted">å¹¶å‘ <input id="concur" type="number" step="1" value="6" style="width:70px"></label>
      <label class="muted">è¶…æ—¶(ç§’) <input id="timeout" type="number" step="1" value="6" style="width:80px"></label>
      <label class="muted"><input type="checkbox" id="shuffle" checked> éšæœºæŠ½æ ·</label>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="pill">å‚æ•°</div>
      <label class="muted">RSI ä¸‹é™ <input id="rsiLow" type="number" step="1" value="45" style="width:80px"></label>
      <label class="muted">RSI ä¸Šé™ <input id="rsiHigh" type="number" step="1" value="65" style="width:80px"></label>
      <label class="muted">æ”¾é‡é˜ˆå€¼ <input id="volX" type="number" step="0.1" value="1.5" style="width:90px"></label>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="pill">æ’åºï¼ˆåˆ‡æ¢å³ç”Ÿæ•ˆï¼‰</div>
      <label class="muted"><input type="radio" name="sortby" value="score" checked> æŒ‰æŠ€æœ¯è¯„åˆ†</label>
      <label class="muted"><input type="radio" name="sortby" value="mcap_desc"> æŒ‰å¸‚å€¼ä»å¤§åˆ°å°</label>
      <label class="muted"><input type="radio" name="sortby" value="mcap_asc"> æŒ‰å¸‚å€¼ä»å°åˆ°å¤§</label>
      <label class="muted"><input type="radio" name="sortby" value="score_mcap"> æŒ‰ è¯„åˆ†Ã—å¸‚å€¼</label>
    </div>

    <div class="row" style="margin-top:8px;gap:10px">
      <div class="pill">è¿›åº¦</div>
      <div class="row mono"><span id="done">0</span>/<span id="total">0</span></div>
      <progress id="prog" max="100" value="0"></progress>
      <span class="muted" id="log">â€”</span>
    </div>
    <div class="muted" id="stats" style="margin-top:6px">æœªå¼€å§‹</div>
    <div id="logbox" style="margin-top:10px;display:none"></div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center">
      <div class="pill">Top</div>
      <select id="topN">
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span>ï¼ˆæœ€æ–°æ”¶ç›˜æ—¥ï¼‰</span>
    </div>
    <div style="max-height:400px; overflow-y:auto;">
      <table id="tbl">
        <thead><tr>
          <th>ä»£ç </th><th>äº¤æ˜“æ‰€</th><th class="sortable" data-col="price">ä»·æ ¼</th><th class="sortable" data-col="score">åˆ†æ•°</th><th class="sortable" data-col="mcap">å¸‚å€¼</th><th class="sortable" data-col="trend">è¶‹åŠ¿</th><th class="sortable" data-col="pull">å›æ’¤</th><th class="sortable" data-col="rsi">RSI</th><th class="sortable" data-col="volx">é‡èƒ½x</th><th>å»ºè®®</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="muted">å¸‚å€¼æ˜¾ç¤ºï¼šâ‰¥1 äº¿æ˜¾ç¤ºâ€œäº¿â€ï¼Œå¦åˆ™â€œç™¾ä¸‡â€ï¼›æ’åºæŒ‰ç¾å…ƒæ•°å€¼ã€‚</div>
  </div>

  <div class="card">
    <div class="pill">å•ç¥¨åˆ†æ</div>
    <div class="tabs" style="margin-top:6px">
      <div class="tab sub active" data-pane="online">åœ¨çº¿å–æ•°</div>
      <div class="tab sub" data-pane="offline">ç¦»çº¿ç²˜è´´è§£æ</div>
      <div class="tab sub" data-pane="manual">æ‰‹åŠ¨è¾“å…¥</div>
    </div>

    <!-- åœ¨çº¿ -->
    <div id="online" class="pane sub active" style="margin-top:12px">
      <div class="grid">
        <div><label class="muted">è‚¡ç¥¨ä»£ç </label><input id="sym" placeholder="å¦‚ TSLA / AAPL / 0700.HK / 000001.SZ"></div>
        <div><label class="muted">æ•°æ®æº</label>
          <select id="source">
            <option value="twelve">TwelveDataï¼ˆéœ€Keyï¼‰</option>
            <option value="yahoo_proxy" selected>Yahooï¼ˆä»£ç†ï¼Œå…Keyï¼‰</option>
            <option value="stooq">Stooqï¼ˆCSVï¼Œå…Keyï¼›å¦‚ tsla.usï¼‰</option>
          </select>
        </div>
        <div id="twkeywrap"><label class="muted">TwelveData API Key</label><input id="twkey" placeholder="åœ¨ twelvedata.com å…è´¹è·å–"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="fetch">è·å–å¹¶è®¡ç®—æŒ‡æ ‡</button>
        <span class="muted" id="fetchlog">â€”</span>
      </div>
    </div>

    <!-- ç¦»çº¿ -->
    <div id="offline" class="pane sub" style="margin-top:12px">
      <div class="pill">ç²˜è´´å†å²Kçº¿ï¼ˆDate,Open,High,Low,Close,Volumeï¼‰</div>
      <div class="muted" style="margin-top:8px">ç¤ºä¾‹ï¼š<code>2025-10-08, 27.10, 29.48, 26.11, 26.60, 7242200</code></div>
      <textarea id="csv" placeholder="è‡³å°‘ 7 è¡Œï¼›å»ºè®® â‰¥60 è¡Œæ›´ç¨³"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="parse">è§£æå¹¶è®¡ç®—æŒ‡æ ‡</button>
        <button class="btn secondary" id="pasteDemo">ä¸€é”®ç²˜è´´ç¤ºä¾‹ï¼ˆ7è¡Œï¼‰</button>
      </div>
    </div>

    <!-- æ‰‹åŠ¨ -->
    <div id="manual" class="pane sub" style="margin-top:12px">
      <div class="row">
        <div class="pill">å‚æ•°ä¸ç»“æœ</div>
        <div class="row" style="margin-left:auto">
          <button class="btn secondary" id="save">ä¿å­˜</button>
          <button class="btn" id="load">è¯»å–</button>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div><label class="muted">è‚¡ç¥¨ä»£ç /å¤‡æ³¨</label><input id="ticker" placeholder="AAPL / BILI"></div>
        <div><label class="muted">æœ€æ–°ä»· Close</label><input id="close" type="number" step="0.01"></div>
        <div><label class="muted">MA5</label><input id="ma5" type="number" step="0.01"></div>
        <div><label class="muted">MA10</label><input id="ma10" type="number" step="0.01"></div>
        <div><label class="muted">MA20</label><input id="ma20" type="number" step="0.01"></div>
        <div><label class="muted">MA60</label><input id="ma60" type="number" step="0.01"></div>
        <div><label class="muted">RSI(14)</label><input id="rsi" type="number" step="0.1"></div>
        <div><label class="muted">å½“æ—¥æˆäº¤é‡</label><input id="vol" type="number" step="1"></div>
        <div><label class="muted">20æ—¥å‡é‡</label><input id="vol20" type="number" step="1"></div>
        <div><label class="muted">ATR(14)</label><input id="atr" type="number" step="0.01"></div>
      </div>
    </div>

    <div class="pill" style="margin-top:12px">é˜ˆå€¼å‚æ•°ï¼ˆå¯æ”¹ï¼‰</div>
    <div class="grid" style="margin-top:12px">
      <div><label class="muted">RSI ä¸‹é™</label><input id="rsiLow2" type="number" step="1" value="45"></div>
      <div><label class="muted">RSI ä¸Šé™</label><input id="rsiHigh2" type="number" step="1" value="65"></div>
      <div><label class="muted">æ”¾é‡é˜ˆå€¼ï¼ˆç°é‡/20å‡é‡ï¼‰</label><input id="volX2" type="number" step="0.1" value="1.5"></div>
      <div><label class="muted">ATR æ­¢æŸå€æ•°</label><input id="slMult" type="number" step="0.1" value="1.5"></div>
      <div><label class="muted">ATR æ­¢ç›ˆå€æ•°</label><input id="tpMult" type="number" step="0.1" value="2.0"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="calc">è®¡ç®—å»ºè®®</button>
      <span class="muted">æ€»åˆ† = 40%è¶‹åŠ¿ + 25%å›æ’¤è´¨é‡ + 20%åŠ¨èƒ½ + 15%é‡èƒ½ï¼›ä¹°å…¥â‰¥30ï¼Œå°ä»“/æŒæœ‰â‰¥10ï¼Œå–å‡ºâ‰¤-30</span>
    </div>

    <div class="kpi" style="margin-top:12px">
      <div><div class="label">å»ºè®®åŠ¨ä½œ</div><div class="val" id="act">â€”</div></div>
      <div><div class="label">æŒæœ‰å‘¨æœŸï¼ˆä¼°ï¼‰</div><div class="val" id="holdPeriod">â€”</div></div>
      <div><div class="label">æ­¢æŸï¼ˆâ‰ˆï¼‰</div><div class="val" id="sl">â€”</div></div>
      <div><div class="label">æ­¢ç›ˆï¼ˆâ‰ˆï¼‰</div><div class="val" id="tp">â€”</div></div>
      <div><div class="label">æ€»åˆ†</div><div class="val" id="score">â€”</div></div>
    </div>
    <div style="margin-top:12px">
      <div class="bar"><span id="bar"></span></div>
      <div class="muted" id="why" style="margin-top:8px">ç†ç”±ï¼šâ€”</div>
    </div>
  </div>
</div>

<script>
// ======= å°å·¥å…· =======
const $ = id => document.getElementById(id);
function showPane(id, parent = document) {
  parent.querySelectorAll('.pane.sub').forEach(p => p.classList.remove('active'));
  $(id).classList.add('active');
}
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    if (t.classList.contains('sub')) {
      showPane(t.dataset.pane, t.closest('.card'));
    } else {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
      $(t.dataset.pane).classList.add('active');
    }
  });
});

function sma(arr, n) {
  const out = new Float64Array(arr.length).fill(NaN);
  let sum = 0;
  for (let i = 0; i < arr.length; i++) {
    sum += arr[i];
    if (i >= n) sum -= arr[i - n];
    if (i >= n - 1) out[i] = sum / n;
  }
  return out;
}
function rsi(closes, p = 14) {
  const out = new Float64Array(closes.length).fill(NaN);
  let pg = 0, pl = 0;
  for (let i = 1; i < closes.length; i++) {
    const d = closes[i] - closes[i - 1], g = Math.max(d, 0), l = Math.max(-d, 0);
    if (i === p) {
      for (let j = 1; j <= p; j++) {
        const dd = closes[j] - closes[j - 1];
        pg += Math.max(dd, 0);
        pl += Math.max(-dd, 0);
      }
      pg /= p;
      pl /= p;
      const rs = pl === 0 ? 100 : pg / (pl || 1e-12);
      out[i] = 100 - 100 / (1 + rs);
    } else if (i > p) {
      pg = (pg * (p - 1) + g) / p;
      pl = (pl * (p - 1) + l) / p;
      const rs = pl === 0 ? 100 : pg / (pl || 1e-12);
      out[i] = 100 - 100 / (1 + rs);
    }
  }
  return out;
}
function atr(highs, lows, closes, p = 14) {
  const tr = new Float64Array(highs.length);
  for (let i = 0; i < highs.length; i++) {
    if (i === 0) {
      tr[i] = highs[i] - lows[i];
      continue;
    }
    const tr1 = highs[i] - lows[i], tr2 = Math.abs(highs[i] - closes[i - 1]), tr3 = Math.abs(lows[i] - closes[i - 1]);
    tr[i] = Math.max(tr1, tr2, tr3);
  }
  return sma(tr, p);
}
function formatMcapUSD(m) {
  if (!Number.isFinite(m)) return "â€”";
  return m >= 1e8 ? (m / 1e8).toFixed(2).replace(/\.00$/, '') + " äº¿" : Math.round(m / 1e6).toLocaleString() + " ç™¾ä¸‡";
}

// ======= Scannerï¼šç›®å½•ä¸å–æ•° =======
const NASDAQ_URL = "https://r.jina.ai/https://www.nasdaqtrader.com/dynamic/symdir/nasdaqlisted.txt";
const OTHER_URL = "https://r.jina.ai/https://www.nasdaqtrader.com/dynamic/symdir/otherlisted.txt";
async function fetchText(url) {
  const r = await fetch(url, { cache: 'force-cache' });
  if (!r.ok) throw new Error("ç›®å½•å¤±è´¥ " + r.status);
  return await r.text();
}
function parsePipe(txt) {
  const lines = txt.trim().split(/\r?\n/);
  return lines
    .filter(l => l && !/^File Creation Time/i.test(l) && !/^Symbol\|/i.test(l) && !/^ACT Symbol\|/i.test(l) && !/^\d+\s+records/i.test(l))
    .map(l => l.split("|"));
}
let universe = [];
function loadUniverse(rowsNas, rowsOth) {
  universe = [
    ...rowsNas.map(([sym, name, , test, , , etf]) => ({ symbol: sym, exch: "NASDAQ", name, etf: etf === "Y", test: test === "Y" })),
    ...rowsOth.map(([sym, name, exch, , etf, , test]) => ({ symbol: sym, exch: exch === "N" ? "NYSE" : (exch === "A" ? "AMEX" : exch), name, etf: etf === "Y", test: test === "Y" }))
  ].filter(x => x.symbol && x.symbol !== "Symbol" && x.symbol !== "ACT Symbol");
}
async function reload() {
  $("log").textContent = "æ‹‰å–ç›®å½•â€¦";
  const [t1, t2] = await Promise.all([fetchText(NASDAQ_URL), fetchText(OTHER_URL)]);
  loadUniverse(parsePipe(t1), parsePipe(t2));
  $("stats").textContent = `å·²è½½å…¥ï¼š${universe.length} æ¡ï¼ˆNASDAQ/NYSE/AMEXï¼‰`;
  $("log").textContent = "ç›®å½•åŠ è½½å®Œæˆã€‚";
}
function shuffleInPlace(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// Price/volume data sources
async function fetchYahooChart(symbol, range = "6mo") {
  const u = `https://r.jina.ai/https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=1d`;
  const r = await fetch(u, { cache: 'force-cache' });
  if (!r.ok) throw new Error("Y!chart " + r.status);
  const txt = await r.text();
  let j;
  try { j = JSON.parse(txt); } catch (e) {
    const m = txt.match(/\{.*"chart".*\}/s);
    if (!m) throw new Error("Y!parse");
    j = JSON.parse(m[0]);
  }
  const res = j.chart?.result?.[0];
  if (!res) throw new Error("Y!nores");
  const ts = res.timestamp || [], q = res.indicators.quote?.[0] || {};
  if (!ts.length) throw new Error("Y!notime");
  return ts.map((t, i) => ({
    date: new Date(t * 1000).toISOString().slice(0, 10),
    open: +(q.open?.[i] ?? NaN), high: +(q.high?.[i] ?? NaN), low: +(q.low?.[i] ?? NaN),
    close: +(q.close?.[i] ?? NaN), volume: +(q.volume?.[i] ?? 0)
  })).filter(r => Number.isFinite(r.close));
}
async function fetchStooq(symbol) {
  const s = symbol.toLowerCase().replace(/\s+/g, '').replace(/\//g, '-').replace(/\./g, '-') + ".us";
  const u = `https://r.jina.ai/http://stooq.com/q/d/l/?s=${encodeURIComponent(s)}&i=d`;
  const r = await fetch(u, { cache: 'force-cache' });
  if (!r.ok) throw new Error("Stooq " + r.status);
  const txt = await r.text();
  const lines = txt.trim().split(/\r?\n/);
  if (lines.length < 2) throw new Error("Stooq empty");
  return lines.slice(1).map(line => {
    const [date, open, high, low, close, volume] = line.split(',').map(x => x.trim());
    return { date, open: +open, high: +high, low: +low, close: +close, volume: +volume };
  }).filter(r => Number.isFinite(r.close));
}
async function fetchTwelve(symbol, key) {
  const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=1day&outputsize=260&order=ASC&apikey=${encodeURIComponent(key)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Twelve " + res.status);
  const j = await res.json();
  if (!j.values) throw new Error(j.message || "æ— æ•°æ®");
  return j.values.map(o => ({ date: o.datetime, open: +o.open, high: +o.high, low: +o.low, close: +o.close, volume: +(o.volume || 0) }));
}
async function fetchRowsBySource(symbol, src, key) {
  if (src === 'yahoo') return fetchYahooChart(symbol, "6mo");
  if (src === 'stooq') return fetchStooq(symbol);
  if (src === 'twelve') return fetchTwelve(symbol, key);
  throw new Error("æœªçŸ¥æº");
}

async function fetchMarketCapYahooBatch(symbols) {
  const chunk = 50, out = new Map();
  for (let i = 0; i < symbols.length; i += chunk) {
    const part = symbols.slice(i, i + chunk).join(",");
    try {
      const u = `https://r.jina.ai/https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(part)}`;
      const r = await fetch(u);
      if (!r.ok) continue;
      const j = await r.json();
      (j?.quoteResponse?.result || []).forEach(o => {
        if (o?.symbol) out.set(o.symbol, (typeof o.marketCap === "number") ? o.marketCap : NaN);
      });
    } catch (_) {}
  }
  return out;
}

function calcLatest(rows, rsiLow, rsiHigh, volX) {
  if (rows.length < 7) throw new Error("å†å²ä¸è¶³7è¡Œ");
  const closes = new Float64Array(rows.map(r => r.close));
  const highs = new Float64Array(rows.map(r => r.high));
  const lows = new Float64Array(rows.map(r => r.low));
  const vols = new Float64Array(rows.map(r => r.volume));
  const ma5 = sma(closes, 5), ma10 = sma(closes, 10), ma20 = sma(closes, 20), ma60 = sma(closes, 60);
  const rsi14 = rsi(closes, 14), vol20 = sma(vols, 20), i = rows.length - 1;
  const close = closes[i], rsiVal = rsi14[i], v = vols[i], v20 = vol20[i];
  const trend = (close > ma5[i] && ma5[i] > ma10[i] && ma10[i] > ma20[i] && ma20[i] > ma60[i]) ? 1 : (close < ma60[i] ? -1 : 0);
  const momo = (rsiVal >= rsiLow && rsiVal <= rsiHigh) ? 1 : ((rsiVal < rsiLow - 5 || rsiVal > 75) ? -1 : 0);
  const dist = (close - ma5[i]) / (close || 1);
  const pull = (0 <= dist && dist <= 0.02) ? 1 : (dist < -0.01 ? -1 : 0);
  const volok = (v / (v20 || 1) >= volX) ? 1 : 0;
  const score = 40 * trend + 25 * pull + 20 * momo + 15 * volok;
  let act = "è§‚æœ›";
  if (score >= 30) act = "ä¹°å…¥";
  else if (score >= 10) act = "å°ä»“/æŒæœ‰";
  else if (score <= -30) act = "å–å‡º/æ­¢æŸ";
  return { price: close, rsi: rsiVal, volx: v / (v20 || 1), score, trend, pull, act };
}

let currentSortCol = 'score';
let currentSortDir = -1; // -1 desc, 1 asc

function getSorter(col, dir) {
  const getVal = x => Number.isFinite(x[col]) ? x[col] : 0;
  if (col === 'score_mcap') {
    return (a, b) => dir * ((getVal(a, 'score') * getVal(a, 'mcap')) - (getVal(b, 'score') * getVal(b, 'mcap')));
  } else {
    return (a, b) => dir * (getVal(a, col) - getVal(b, col));
  }
}

function setArrow() {
  document.querySelectorAll('th.sortable').forEach(th => {
    if (!th.dataset.orig) th.dataset.orig = th.textContent;
    th.textContent = th.dataset.orig;
  });
  const th = document.querySelector(`th[data-col="${currentSortCol}"]`);
  if (th) {
    th.textContent = th.dataset.orig + (currentSortDir === -1 ? ' â†“' : ' â†‘');
  }
}

function renderTop(list) {
  const sorter = getSorter(currentSortCol, currentSortDir);
  const sorted = list.slice().sort(sorter);
  const selectedN = parseInt($('topN').value || 10, 10);
  const n = Math.min(selectedN, sorted.length);
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  const fragment = document.createDocumentFragment();
  sorted.slice(0, n).forEach(x => {
    const trendTxt = x.trend > 0 ? "å¤šå¤´" : (x.trend < 0 ? "èµ°å¼±" : "ä¸€èˆ¬");
    const pullTxt = x.pull > 0 ? "è‰¯å¥½" : (x.pull < 0 ? "è¾ƒå·®" : "ä¸€èˆ¬");
    const actClass = x.act === "ä¹°å…¥" ? "good" : (x.act === "å–å‡º/æ­¢æŸ" ? "bad" : "warn");
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.symbol}</td>
      <td>${x.exch}</td>
      <td>${Number.isFinite(x.price) ? x.price.toFixed(2) : "â€”"}</td>
      <td><b>${x.score > 0 ? '+' : ''}${Math.round(x.score)}</b></td>
      <td>${formatMcapUSD(x.mcap)}</td>
      <td>${trendTxt}</td>
      <td>${pullTxt}</td>
      <td>${Number.isFinite(x.rsi) ? x.rsi.toFixed(1) : "â€”"}</td>
      <td>${Number.isFinite(x.volx) ? x.volx.toFixed(2) : "â€”"}</td>
      <td class="${actClass}">${x.act}</td>`;
    fragment.appendChild(tr);
  });
  tbody.appendChild(fragment);
  setArrow();
}

// Resort on radio change
document.querySelectorAll('input[name="sortby"]').forEach(r => r.addEventListener('change', () => {
  const mode = r.value;
  if (mode === 'score') { currentSortCol = 'score'; currentSortDir = -1; }
  else if (mode === 'mcap_desc') { currentSortCol = 'mcap'; currentSortDir = -1; }
  else if (mode === 'mcap_asc') { currentSortCol = 'mcap'; currentSortDir = 1; }
  else if (mode === 'score_mcap') { currentSortCol = 'score_mcap'; currentSortDir = -1; }
  if (lastResults.length) renderTop(lastResults);
}));

// Top N change
$('topN').addEventListener('change', () => {
  if (lastResults.length) renderTop(lastResults);
});

// Column sort
document.querySelectorAll('th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if (col === currentSortCol) {
      currentSortDir = -currentSortDir;
    } else {
      currentSortCol = col;
      currentSortDir = -1;
    }
    renderTop(lastResults);
  });
});

// Toggle TwelveData key box
$('priceSource').addEventListener('change', () => {
  $('twKeyWrap').style.display = $('priceSource').value === 'twelve' ? 'inline-flex' : 'none';
});

// Scanner main
let stopFlag = false;
$('reload').onclick = reload;
$('stop').onclick = () => { stopFlag = true; };
$('scan').onclick = async () => {
  stopFlag = false;
  $("logbox").innerHTML = '';
  $("logbox").style.display = 'none';
  const rsiLow = +($('rsiLow').value || 45), rsiHigh = +($('rsiHigh').value || 65), volX = +($('volX').value || 1.5);
  const mode = (document.querySelector('input[name="sortby"]:checked') || {}).value || 'score';
  if (mode === 'score') { currentSortCol = 'score'; currentSortDir = -1; }
  else if (mode === 'mcap_desc') { currentSortCol = 'mcap'; currentSortDir = -1; }
  else if (mode === 'mcap_asc') { currentSortCol = 'mcap'; currentSortDir = 1; }
  else if (mode === 'score_mcap') { currentSortCol = 'score_mcap'; currentSortDir = -1; }
  const priceSrc = $('priceSource').value, mcapSrc = $('mcapSource').value, twKey = $('twKey').value.trim();
  if (priceSrc === 'twelve' && !twKey) { alert('è¯·è¾“å…¥ TwelveData Key'); return; }
  if (!universe.length) await reload();
  const pool = universe.filter(it => {
    if ($('noETF').checked && it.etf) return false;
    if (it.test) return false;
    if (!$('exNAS').checked && it.exch === 'NASDAQ') return false;
    if (!$('exNYS').checked && it.exch === 'NYSE') return false;
    if (!$('exASE').checked && (it.exch === 'AMEX' || it.exch === 'ASE')) return false;
    const nm = (it.name || '').toUpperCase();
    if ($('noWUR').checked && (nm.includes('WARRANT') || nm.includes('UNIT') || nm.includes('RIGHT'))) return false;
    if ($('onlyCommon').checked && (nm.includes('PREFERRED') || nm.includes('DEPOSITARY') || nm.includes('ETN') || nm.includes('NOTE'))) return false;
    return true;
  });
  const list = ($('shuffle').checked ? shuffleInPlace([...pool]) : pool).slice(0, Math.max(10, parseInt($('limit').value || "80", 10)));
  $('total').textContent = String(list.length);
  $('done').textContent = '0';
  $('prog').max = list.length;
  $('prog').value = 0;
  $('log').textContent = 'å¼€å§‹æŠ“å–â€¦';
  $('scan').disabled = true;
  $('stop').disabled = false;

  let preCapMap = new Map();
  if (mcapSrc === 'yahoo' && (mode === 'mcap_desc' || mode === 'mcap_asc' || mode === 'score_mcap')) {
    $('log').textContent = 'æ‰¹é‡è·å–å¸‚å€¼â€¦';
    preCapMap = await fetchMarketCapYahooBatch(list.map(x => x.symbol));
  }
  const results = [];
  const concur = Math.max(1, parseInt($('concur').value || "6", 10));
  const timeoutMs = Math.max(3, +($('timeout').value || 6)) * 1000;

  async function processBatch(start, end) {
    const tasks = [];
    for (let i = start; i < end && i < list.length; i++) {
      if (stopFlag) return;
      const it = list[i];
      tasks.push((async () => {
        try {
          $('log').textContent = `æŠ“å– ${it.symbol} (${i + 1}/${list.length})`;
          const rows = await Promise.race([fetchRowsBySource(it.symbol, priceSrc, twKey), new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), timeoutMs))]);
          const calc = calcLatest(rows, rsiLow, rsiHigh, volX);
          const mc = mcapSrc === 'yahoo' ? preCapMap.get(it.symbol) || NaN : NaN;
          results.push({ symbol: it.symbol, exch: it.exch, mcap: mc, ...calc });
        } catch (e) {
          const box = $('logbox');
          box.style.display = 'block';
          box.innerHTML += `<div>${it.symbol}: å¤±è´¥ (${e.message || e})</div>`;
        } finally {
          const done = parseInt($('done').textContent) + 1;
          $('done').textContent = String(done);
          $('prog').value = done;
        }
      })());
    }
    await Promise.all(tasks);
  }

  const batchSize = Math.ceil(list.length / concur);
  for (let i = 0; i < list.length && !stopFlag; i += batchSize) {
    await processBatch(i, i + batchSize);
  }

  if (!stopFlag) {
    lastResults = results;
    renderTop(lastResults);
    $('log').textContent = 'å®Œæˆã€‚';
  } else {
    $('log').textContent = 'å·²åœæ­¢ã€‚';
  }
  $('scan').disabled = false;
  $('stop').disabled = true;
};

// ======= å•ç¥¨åˆ†æ =======
function setVal(id, v) { const el = $(id); el.value = Number.isFinite(v) ? v.toFixed(4) : ""; }
function getNum(id) { return parseFloat(($(`${id}`).value || "").trim()); }
function setTxt(id, s) { $(id).textContent = s; }
function logfetch(s) { $('fetchlog').textContent = s; }

$('source').addEventListener('change', () => {
  $('twkeywrap').style.display = $('source').value === 'twelve' ? 'block' : 'none';
});

async function fetchYahooProxy(symbol) {
  logfetch("è¯·æ±‚ Yahooï¼ˆä»£ç†ï¼‰â€¦");
  const url = `https://r.jina.ai/https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=1y&interval=1d`;
  const res = await fetch(url, { cache: 'force-cache' });
  if (!res.ok) throw new Error("ç½‘ç»œé”™è¯¯ï¼š" + res.status);
  const text = await res.text();
  let j;
  try { j = JSON.parse(text); } catch (e) {
    const m = text.match(/\{.*"chart".*\}/s);
    if (!m) throw new Error("è§£æå¤±è´¥ï¼šè¿”å›ä¸æ˜¯JSON");
    j = JSON.parse(m[0]);
  }
  const r = j.chart?.result?.[0];
  if (!r) throw new Error("Yahoo æ— è¿”å›ç»“æœ");
  const ts = r.timestamp || [], q = r.indicators.quote?.[0] || {};
  if (!ts.length) throw new Error("Yahoo æ— æ—¶é—´åºåˆ—");
  const rows = ts.map((t, i) => ({
    date: new Date(t * 1000).toISOString().slice(0, 10),
    open: +(q.open?.[i] ?? NaN), high: +(q.high?.[i] ?? NaN), low: +(q.low?.[i] ?? NaN),
    close: +(q.close?.[i] ?? NaN), volume: +(q.volume?.[i] ?? 0)
  })).filter(r => Number.isFinite(r.close));
  if (rows.length < 7) throw new Error("Yahoo æ•°æ®ä¸è¶³ 7 è¡Œ");
  return rows;
}
async function fetchStooqSingle(symbol) { return fetchStooq(symbol); }
async function fetchTwelveSingle(symbol, key) { return fetchTwelve(symbol, key); }
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/).filter(x => x.trim());
  const out = lines.map(raw => {
    let p = raw.split(',');
    if (p.length < 5) p = raw.trim().split(/\s+/);
    if (p.length < 5) return null;
    const [d, o, h, l, c, v] = p.map(x => x.trim());
    const num = t => parseFloat(String(t || "").replace(/,/g, ''));
    return { date: d, open: num(o), high: num(h), low: num(l), close: num(c), volume: num(v || "0") };
  }).filter(x => x);
  return out;
}
function fillFromRows(rows) {
  if (rows.length < 7) throw new Error("è¿”å›æ•°æ®ä¸è¶³ 7 è¡Œ");
  const closes = new Float64Array(rows.map(r => r.close));
  const highs = new Float64Array(rows.map(r => r.high));
  const lows = new Float64Array(rows.map(r => r.low));
  const vols = new Float64Array(rows.map(r => r.volume));
  const ma5 = sma(closes, 5), ma10 = sma(closes, 10), ma20 = sma(closes, 20), ma60 = sma(closes, 60);
  const rsi14 = rsi(closes, 14), atr14 = atr(highs, lows, closes, 14), vol20 = sma(vols, 20);
  const i = rows.length - 1;
  setVal('close', closes[i]);
  setVal('ma5', ma5[i]);
  setVal('ma10', ma10[i]);
  setVal('ma20', ma20[i]);
  setVal('ma60', ma60[i]);
  setVal('rsi', rsi14[i]);
  setVal('atr', atr14[i]);
  setVal('vol', vols[i]);
  setVal('vol20', vol20[i]);
}
$('fetch').onclick = async () => {
  try {
    const sym = $('sym').value.trim();
    const src = $('source').value;
    if (!sym) { alert("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç "); return; }
    $('ticker').value = sym;
    let rows;
    if (src === 'twelve') {
      const key = $('twkey').value.trim();
      if (!key) { alert("è¯·è¾“å…¥ TwelveData Key"); return; }
      rows = await fetchTwelveSingle(sym, key);
    } else if (src === 'yahoo_proxy') {
      rows = await fetchYahooProxy(sym);
    } else {
      rows = await fetchStooqSingle(sym);
    }
    rows.sort((a, b) => new Date(a.date) - new Date(b.date));
    logfetch(`è·å–æˆåŠŸï¼š${rows.length} è¡Œã€‚æ­£åœ¨è®¡ç®—â€¦`);
    fillFromRows(rows);
    logfetch("å®Œæˆï¼šæŒ‡æ ‡å·²è‡ªåŠ¨å¡«å…¥ï¼ˆMA5/10/20/60ã€RSIã€ATRã€é‡èƒ½ï¼‰ã€‚");
    showPane('manual', $('scanner'));
  } catch (e) {
    logfetch("âŒ " + (e.message || e));
    alert("è·å–å¤±è´¥ï¼š" + (e.message || e));
  }
};
$('parse').onclick = () => {
  const rows = parseCSV($('csv').value);
  if (rows.length < 7) { alert("è‡³å°‘éœ€è¦ 7 è¡Œæ•°æ®"); return; }
  fillFromRows(rows);
  logfetch(`ç¦»çº¿è§£ææˆåŠŸï¼š${rows.length} è¡Œã€‚æŒ‡æ ‡å·²å¡«å…¥ã€‚`);
  showPane('manual', $('scanner'));
};
$('pasteDemo').onclick = () => {
  const demo = [
    "2025-10-10, 458.40, 471.20, 452.10, 466.80, 102340000",
    "2025-10-09, 452.30, 463.50, 448.20, 458.10, 97320000",
    "2025-10-08, 446.80, 454.90, 440.60, 447.70, 96850000",
    "2025-10-07, 440.50, 451.30, 432.40, 442.90, 93410000",
    "2025-10-06, 448.90, 455.20, 438.80, 446.10, 88940000",
    "2025-10-03, 439.60, 448.40, 432.00, 439.80, 91560000",
    "2025-10-02, 436.20, 444.70, 429.50, 436.90, 90130000"
  ].join("\n");
  const ta = $('csv');
  ta.value = demo;
  ta.focus();
  alert("å·²å¡«å…¥ 7 è¡Œç¤ºä¾‹ï¼Œå¯ç‚¹â€œè§£æå¹¶è®¡ç®—æŒ‡æ ‡â€ã€‚ï¼ˆç¤ºä¾‹æ•°æ®ä»…ç”¨äºæ¼”ç¤ºï¼‰");
};
$('save').onclick = () => {
  const keys = ["ticker", "close", "ma5", "ma10", "ma20", "ma60", "rsi", "vol", "vol20", "atr", "rsiLow2", "rsiHigh2", "volX2", "slMult", "tpMult"];
  const data = {};
  keys.forEach(k => data[k] = $(k).value);
  localStorage.setItem("stock_logic_ma5_10_20_60_allin1", JSON.stringify(data));
  alert("å·²ä¿å­˜åˆ°æœ¬æœºæµè§ˆå™¨");
};
$('load').onclick = () => {
  const raw = localStorage.getItem("stock_logic_ma5_10_20_60_allin1");
  if (!raw) { alert("æ²¡æœ‰ä¿å­˜çš„æ•°æ®"); return; }
  const data = JSON.parse(raw);
  Object.keys(data).forEach(k => { const el = $(k); if (el) el.value = data[k]; });
};
$('calc').onclick = () => {
  const close = getNum('close'), ma5 = getNum('ma5'), ma10 = getNum('ma10'), ma20 = getNum('ma20'), ma60 = getNum('ma60');
  const rsi = getNum('rsi'), vol = getNum('vol'), vol20 = getNum('vol20'), atrv = getNum('atr');
  const rsiLow = getNum('rsiLow2'), rsiHigh = getNum('rsiHigh2'), volX = getNum('volX2'), slMult = getNum('slMult'), tpMult = getNum('tpMult');
  if (![close, ma5, ma10, ma20, ma60, rsi, vol, vol20, atrv].every(Number.isFinite)) {
    alert("è¯·å…ˆè·å–/ç²˜è´´æ•°æ®æˆ–è¡¥é½å…³é”®å€¼");
    return;
  }
  const trend = (close > ma5 && ma5 > ma10 && ma10 > ma20 && ma20 > ma60) ? 1 : (close < ma60 ? -1 : 0);
  const momo = (rsi >= rsiLow && rsi <= rsiHigh) ? 1 : ((rsi < rsiLow - 5 || rsi > 75) ? -1 : 0);
  const dist = (close - ma5) / (close || 1);
  const pull = (0 <= dist && dist <= 0.02) ? 1 : (dist < -0.01 ? -1 : 0);
  const volx = vol / (vol20 || 1);
  const volok = (volx >= volX) ? 1 : 0;
  const score = 40 * trend + 25 * pull + 20 * momo + 15 * volok;
  const sl = close - slMult * atrv;
  const tp = Math.max(close * 1.15, close + tpMult * atrv);
  let act = "è§‚æœ›";
  if (score >= 30) act = "ä¹°å…¥";
  else if (score >= 10) act = "å°ä»“/æŒæœ‰";
  else if (score <= -30) act = "å–å‡º/æ­¢æŸ";
  let holdPeriod = "â€”";
  let holdReason = "";
  if (act === "ä¹°å…¥") {
    let days = 5 + Math.floor(Math.sqrt(score - 30) * 3); // éçº¿æ€§åŸºç¡€ï¼šåˆ†æ•°è¶Šé«˜å¢é•¿è¶Šå¿«
    if (trend === 1) { days += Math.floor(Math.random() * 3) + 4; holdReason += "è¶‹åŠ¿è‰¯å¥½(+4~6å¤©)"; } 
    else if (trend === 0) { days += Math.floor(Math.random() * 2) + 1; holdReason += "è¶‹åŠ¿ä¸€èˆ¬(+1~2å¤©)"; } 
    else { days -= Math.floor(Math.random() * 3) + 2; holdReason += "è¶‹åŠ¿èµ°å¼±(-2~4å¤©)"; }
    if (pull === 1) { days += Math.floor(Math.random() * 2) + 2; holdReason += ", å›æ’¤è‰¯å¥½(+2~3å¤©)"; }
    else if (pull === -1) { days -= Math.floor(Math.random() * 2) + 1; holdReason += ", å›æ’¤è¾ƒå·®(-1~2å¤©)"; }
    if (rsi >= rsiLow && rsi <= rsiHigh) {
      const rsiPos = (rsi - rsiLow) / (rsiHigh - rsiLow); // 0~1ä½ç½®
      const rsiAdd = rsiPos < 0.5 ? 2 : 4; // åä½çŸ­æœŸï¼Œåé«˜ä¸­æœŸ
      days += rsiAdd; holdReason += `, RSIç”œåŒº(${rsiPos < 0.5 ? 'çŸ­æœŸ' : 'ä¸­æœŸ'}+${rsiAdd}å¤©)`;
    }
    if (rsi >= 70) { days -= 3; holdReason += ", RSIè¿‡çƒ­(-3å¤©)"; }
    if (volok) { 
      const volExtra = Math.min(6, Math.floor((volx - volX) * 2)); // è¶…é˜ˆå€¼è¶Šå¤šåŠ è¶Šå¤š
      days += volExtra; holdReason += `, æ”¾é‡è¶…é˜ˆ(+${volExtra}å¤©)`;
    }
    days = Math.min(35, Math.max(5, days));
    holdPeriod = `${days} ä¸ªäº¤æ˜“æ—¥`;
  } else if (act === "å°ä»“/æŒæœ‰") {
    let days = 3 + Math.floor(Math.sqrt(score - 10) * 2); // éçº¿æ€§åŸºç¡€
    if (trend === 1) { days += Math.floor(Math.random() * 3) + 2; holdReason += "è¶‹åŠ¿è‰¯å¥½(+2~4å¤©)"; }
    else if (trend === 0) { days += 1; holdReason += "è¶‹åŠ¿ä¸€èˆ¬(+1å¤©)"; }
    else { days -= 2; holdReason += "è¶‹åŠ¿èµ°å¼±(-2å¤©)"; }
    if (pull === 1) { days += 1; holdReason += ", å›æ’¤è‰¯å¥½(+1å¤©)"; }
    else if (pull === -1) { days -= 1; holdReason += ", å›æ’¤è¾ƒå·®(-1å¤©)"; }
    if (rsi >= rsiLow && rsi <= rsiHigh) { days += 2; holdReason += ", RSIç”œåŒº(+2å¤©)"; }
    if (rsi >= 70) { days -= 1; holdReason += ", RSIè¿‡çƒ­(-1å¤©)"; }
    if (volok) { days += Math.min(3, Math.floor((volx - volX) * 1)); holdReason += `, æ”¾é‡è¶…é˜ˆ(+${Math.min(3, Math.floor((volx - volX) * 1))}å¤©)`; }
    days = Math.min(15, Math.max(3, days));
    holdPeriod = `${days} ä¸ªäº¤æ˜“æ—¥`;
  }
  setTxt('act', act);
  setTxt('holdPeriod', holdPeriod);
  setTxt('sl', Number.isFinite(sl) ? sl.toFixed(2) : "â€”");
  setTxt('tp', Number.isFinite(tp) ? tp.toFixed(2) : "â€”");
  setTxt('score', (score > 0 ? '+' : '') + score.toFixed(0));
  $('bar').style.width = Math.max(0, Math.min(100, (score + 100) / 2)) + '%';
  setTxt('why', `ç†ç”±ï¼šè¶‹åŠ¿${trend > 0 ? 'è‰¯å¥½' : (trend < 0 ? 'èµ°å¼±' : 'ä¸€èˆ¬')}ï¼›å›æ’¤${pull > 0 ? 'è‰¯å¥½' : (pull < 0 ? 'è¾ƒå·®' : 'ä¸€èˆ¬')}ï¼›åŠ¨èƒ½RSI ${rsi.toFixed(1)}ï¼›é‡èƒ½å€æ•° ${volx.toFixed(2)}${holdReason ? ` (å‘¨æœŸè°ƒæ•´: ${holdReason})` : ''}ã€‚`);
};

// åˆå§‹åŒ–
reload().catch(e => $('log').textContent = 'ç›®å½•åŠ è½½å¤±è´¥ï¼š' + (e.message || e));
</script>
<!-- Airwallex æŠ˜å æµ®çª—æ”¶æ¬¾æ¨¡å—ï¼ˆé»˜è®¤æ”¶èµ·ï¼Œç‚¹å¼€å³å±•å¼€ï¼‰-->
<div id="awxSupportFloat" 
     style="position:fixed;bottom:24px;right:24px;z-index:9999;cursor:pointer;">
  <!-- æ”¶èµ·æ—¶çš„åœ†å½¢å°æŒ‰é’® -->
  <div id="awxBtn" 
       style="width:56px;height:56px;background:#00d4aa;border-radius:50%;box-shadow:0 6px 20px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:28px;color:white;">
    â˜•
  </div>

  <!-- å±•å¼€åçš„å¡ç‰‡ï¼ˆé»˜è®¤éšè—ï¼‰-->
  <div id="awxPanel" 
       style="position:absolute;bottom:70px;right:0;width:260px;background:#11192e;border:1px solid #1d2a4a;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;transform-origin:bottom right;animation:awxFadeIn 0.3s ease;">
    <div class="pill" style="margin-bottom:10px;font-size:13px;">å–œæ¬¢è¿™ä¸ªå·¥å…·ï¼Ÿè¯·ä½œè€…å–æ¯å’–å•¡ï½</div>
    
    <img src="https://æ‚¨çš„AirwallexäºŒç»´ç å›¾ç‰‡é“¾æ¥.png"
         width="160"
         style="border-radius:12px;margin:8px 0;box-shadow:0 4px 12px rgba(0,0,0,0.4);"
         alt="Airwallex æ”¶æ¬¾äºŒç»´ç ">
    
    <a href="https://pay.airwallex.com/æ‚¨çš„PaymentLinkID"
       target="_blank"
       class="btn"
       style="display:block;background:#00d4aa;color:white;margin:10px 0;padding:10px;border-radius:10px;text-decoration:none;">
      â˜• ç‚¹å‡»æ”¯ä»˜ï¼ˆä»»æ„é‡‘é¢ï¼‰
    </a>
    
    <div class="muted" style="font-size:11px;line-height:1.4;">
      æ”¯æŒWechat/Alipay/Mastercard/Visaç­‰/<br>æ„Ÿè°¢æ¯ä¸€ä½æ”¯æŒè€…ï½
    </div>
    
    <!-- å°å…³é—­æŒ‰é’® -->
    <div style="position:absolute;top:8px;right:10px;color:#666;font-size:20px;cursor:pointer;" 
         onclick="document.getElementById('awxPanel').style.display='none'">
      Ã—
    </div>
  </div>
</div>

<style>
@keyframes awxFadeIn {
  from {opacity:0;transform:scale(0.8);}
  to {opacity:1;transform:scale(1);}
}
</style>

<script>
// ç‚¹å‡»å’–å•¡æŒ‰é’®å±•å¼€/æ”¶èµ·
document.getElementById('awxBtn').addEventListener('click', function(e){
  e.stopPropagation();
  const panel = document.getElementById('awxPanel');
  panel.style.display = (panel.style.display==='block') ? 'none' : 'block';
});
// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹è‡ªåŠ¨æ”¶èµ·ï¼ˆå¯é€‰ï¼‰
document.addEventListener('click', function(e){
  if(!document.getElementById('awxSupportFloat').contains(e.target)){
    document.getElementById('awxPanel').style.display='none';
  }
});
</script>
</body>
</html>
